<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.111.3">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Chase the Devil</title>
  <meta name="description" content="A personal, independent, technical blog" />

  
  <link type="text/css" rel="stylesheet" href="https://chasethedevil.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://chasethedevil.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://chasethedevil.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://chasethedevil.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">
<link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
 <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="https://chasethedevil.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Chase the Devil" />
  <script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://chasethedevil.github.io/"><h1 style="font-family: 'UnifrakturMaguntia', cursive;font-weight: normal;">Chase the Devil</h1></a>
      <p class="lead">
       A personal, independent, technical blog 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://chasethedevil.github.io/">Blog</a> </li>
        <li><a href="/about/"> About </a></li><li><a href="/post/"> Posts </a></li><li><a href="/tags/"> Tags </a></li>
      </ul>

        <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <script type="text/javascript">document.write("<a href=\"mail" + "to:" + new Array("fabien","2ipi.com").join("@") + "?subject=your%20blog\">" + '<i class="fa fa-envelope fa-3x"></i>' + "</" + "a>");</script>
      
      
      
      
      
      
      <a href="https://twitter.com/logos01"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      <a href="https://chasethedevil.github.io/index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-3x"></i></a>
      </li>
    </ul>
 </nav>

    <p>&copy; 2024. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="posts">
<article class="post">
  <h1 class="post-title">
    <a href="https://chasethedevil.github.io/post/java-logging-still-crap-in-2009/">Java Logging Still Crap in 2009</a>
  </h1>
  <time datetime="2009-04-24T15:01:00Z" class="post-date">Fri, Apr 24, 2009</time>
  <p>When java logging API was first introduced in JDK 1.4 in 2002, it caused quite a lot a fuss around, with everybody asking &ldquo;Why did not they just include Log4j instead of creating their own bastard child?&rdquo;.</p>
<p>I remember having looked at it very shortly before continuing using Log4j on all projects I have been involved with.</p>
<p>Today, while doing a very small project, I tried once more to use <a href="http://java.sun.com/j2se/1.4.2/docs/guide/util/logging/overview.html">java logging</a>. The main reason is that I was lazy to add a dependency to one more jar for this small project. While trying I found out that:</p>
<ul>
<li>you still need to use a damned JVM parameter to point to your configuration file</li>
<li>you can not change the formatting without writing a formatter class!</li>
</ul>
<p>It&rsquo;s 2009! What has Sun done? I am amazed the most elementary things you expect from a Logger are still not included by default in the JDK.</p>

  
</article><article class="post">
  <h1 class="post-title">
    <a href="https://chasethedevil.github.io/post/bachelier-vs.-black/">Bachelier vs. Black</a>
  </h1>
  <time datetime="2009-03-23T17:58:00Z" class="post-date">Mon, Mar 23, 2009</time>
   

<a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://4.bp.blogspot.com/_9RyqGT46Fbk/ScfCRxmTocI/AAAAAAAACzk/5_lPpPc7LzU/s1600-h/bachelier_vs_black_normal.png"><img style="margin: 0pt 10px 10px 0pt; float: left; cursor: pointer; width: 400px; height: 300px;" src="http://4.bp.blogspot.com/_9RyqGT46Fbk/ScfCRxmTocI/AAAAAAAACzk/5_lPpPc7LzU/s400/bachelier_vs_black_normal.png" alt="" id="BLOGGER_PHOTO_ID_5316431495761732034" border="0" /></a><br />Black and Scholes gives a strange result for the price of a binary option under high volatility.  You will learn here how to simulate a stock price evolution using Java, and how to show it using JFreeChart library. It starts with more complex concepts (don't be afraid) and goes done towards simpler things.<br /><br />I could not write all that in a blog format, so I created a old HTML page about it <a href="http://31416.appspot.com/static/bachblack/Bachelier_vs_Black.html">here</a> and a <a href="http://31416.appspot.com/static/bachblack/Bachelier_vs_Black.pdf">PDF version</a>.<br /><span style="text-decoration: underline;"></span>



  
</article><article class="post">
  <h1 class="post-title">
    <a href="https://chasethedevil.github.io/post/linux-audio-state--miserable/">Linux Audio State = Miserable</a>
  </h1>
  <time datetime="2009-03-19T12:39:00Z" class="post-date">Thu, Mar 19, 2009</time>
  <p>There are lots of programs for playing MP3 under linux, a few dealing decently with big libraries. But when you start looking for a program that does crossfade well and manage big libraries easily - there is nothing.</p>
<p>Rhythmbox does some crossfade, but crashes when you move manually in the song. Audacious does some crossfade but regularly crashes with crossfade plugin.</p>
<p>The real alternative are AIMP2 or Foobar2000 in Wine. It is quite incredible that you can have good solid crossfade in wine and not natively in Linux.</p>
<p>Maybe people spent too much time on useless Pulseaudio (I have much less issues using only ALSA).</p>

  
</article><article class="post">
  <h1 class="post-title">
    <a href="https://chasethedevil.github.io/post/senior-developers-team-productivity-x4-from-ms-research-paper/">Senior Developers Team Productivity X4 (from MS Research Paper)</a>
  </h1>
  <time datetime="2009-02-10T10:44:00Z" class="post-date">Tue, Feb 10, 2009</time>
   

There is a very interesting <a href="http://research.microsoft.com/en-us/projects/esm/nagappan_tdd.pdf">MS Research paper about test driven development</a> (TDD). It is one of the only real study about it that I know of. The paper conclusions from experiments over 4 TDD teams vs 4 traditional teams is:<br /><blockquote><span style="font-style: italic;">"TDD seems to be applicable in various domains and can significantly reduce the defect density of developed software without significant productivity reduction of the development team"</span></blockquote>Their data gives also other interesting results:<br /><ul><li>An experienced team (5 people over 10 years + 2 people under 5 years) : 155KLOC C# code (+60 test).<br /></li></ul><ul><li>A junior team (3 people under 10 years + 6 people under 5 years): 41 KLOC Java code (+28 test).<br /></li></ul>If you do the ratio of KLOC/man month, you have the following graph:<br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://2.bp.blogspot.com/_9RyqGT46Fbk/SZFVEkXM8JI/AAAAAAAACts/_pwwDhnKTt0/s1600-h/MSPaperKLOCMonth.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 400px; height: 252px;" src="http://2.bp.blogspot.com/_9RyqGT46Fbk/SZFVEkXM8JI/AAAAAAAACts/_pwwDhnKTt0/s400/MSPaperKLOCMonth.png" alt="" id="BLOGGER_PHOTO_ID_5301111773360615570" border="0" /></a><br />I know this is very far from scientific evidence and more like astrology, but still, the most conservative ratio for senior/junior is <span style="font-weight: bold;">4.23</span>!



  
</article><article class="post">
  <h1 class="post-title">
    <a href="https://chasethedevil.github.io/post/the-end-of-rings-around-plain-java---a-better-concurrency-test/">The End Of Rings Around Plain Java - A Better Concurrency Test</a>
  </h1>
  <time datetime="2009-01-15T15:54:00Z" class="post-date">Thu, Jan 15, 2009</time>
  <p>In my <a href="/post/running-rings-around-plain-java---the-killer-code">previous post</a>, I was wondering why single thread was faster. D Andreou gave the correct explanation: as we send only 1 start message and as each node only send 1 message to the next one, there is always only 1 message being processed. So the test is optimum on 1 thread. It does not make much sense to make a multithreading benchmark on a problem that is fundamentally single threaded.</p>
<p>His suggestion was to simple send N start messages where N &gt;= number of processors. In theory, the performance will become optimal with N threads then. Unfortunately this is not what happened in real life. In real life the single threaded performance is still better if you send even 16 messages on a biprocessor machine.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">main</span><span style="color:#666">(</span>String<span style="color:#666">[]</span> args<span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">throws</span> Exception <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>    OptimizedRing ring <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> OptimizedRing<span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>    RingNode node <span style="color:#666">=</span> ring<span style="color:#666">.</span><span style="color:#4070a0">startRing</span><span style="color:#666">(</span>Integer<span style="color:#666">.</span><span style="color:#4070a0">parseInt</span><span style="color:#666">(</span>args<span style="color:#666">[</span>0<span style="color:#666">]));</span>
</span></span><span style="display:flex;"><span>    node<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> StartMessage<span style="color:#666">());</span>
</span></span><span style="display:flex;"><span>    node<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> TokenMessage<span style="color:#666">(</span>node<span style="color:#666">.</span><span style="color:#4070a0">nodeId</span><span style="color:#666">,</span>1<span style="color:#666">));</span>
</span></span><span style="display:flex;"><span>    node<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> TokenMessage<span style="color:#666">(</span>node<span style="color:#666">.</span><span style="color:#4070a0">nodeId</span><span style="color:#666">,</span>1<span style="color:#666">));</span>
</span></span><span style="display:flex;"><span>    node<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> TokenMessage<span style="color:#666">(</span>node<span style="color:#666">.</span><span style="color:#4070a0">nodeId</span><span style="color:#666">,</span>1<span style="color:#666">));</span>
</span></span><span style="display:flex;"><span>    ring<span style="color:#666">.</span><span style="color:#4070a0">executor</span><span style="color:#666">.</span><span style="color:#4070a0">awaitTermination</span><span style="color:#666">(</span>10<span style="color:#666">,</span> TimeUnit<span style="color:#666">.</span><span style="color:#4070a0">MINUTES</span><span style="color:#666">);</span>
</span></span><span style="display:flex;"><span><span style="color:#666">}</span></span></span></code></pre></div>
<p>My idea was that it was related to the swiching from thread to thread overhead, which is precisely what I think the original author of the test had in mind to test. I am not 100% convinced it is really what&rsquo;s happening. I wanted a test that would actually be faster using N threads; so I decided to add a bit of computation at before processing each Token. Unfortunately I had the bad idea to compute Pi by Monte Carlo method to do that. Running my tests I was surprised it did not change the results, and made things worse the most computer intensive the computation was (increasing the number of monte carlo iterations). It scared me a bit wondering what the hell could be wrong there. The following class performs much worse with 2 threads compared to 1:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">BadParallelPi</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">startExecutors</span><span style="color:#666">()</span> <span style="color:#007020;font-weight:bold">throws</span> Exception <span style="color:#666">{</span>        
</span></span><span style="display:flex;"><span>        <span style="color:#902000">long</span> startTime <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#4070a0">currentTimeMillis</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span>startTime<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        ExecutorService executor1 <span style="color:#666">=</span> Executors<span style="color:#666">.</span><span style="color:#4070a0">newFixedThreadPool</span><span style="color:#666">(</span>1<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        executor1<span style="color:#666">.</span><span style="color:#4070a0">execute</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> Computation<span style="color:#666">());</span>
</span></span><span style="display:flex;"><span>        executor1<span style="color:#666">.</span><span style="color:#4070a0">execute</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> Computation<span style="color:#666">());</span>
</span></span><span style="display:flex;"><span>        executor1<span style="color:#666">.</span><span style="color:#4070a0">shutdown</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>        executor1<span style="color:#666">.</span><span style="color:#4070a0">awaitTermination</span><span style="color:#666">(</span>60<span style="color:#666">,</span> TimeUnit<span style="color:#666">.</span><span style="color:#4070a0">SECONDS</span><span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#902000">long</span> delay <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#4070a0">currentTimeMillis</span><span style="color:#666">()</span> <span style="color:#666">-</span> startTime<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;finished single thread in &#34;</span><span style="color:#666">+(</span>delay<span style="color:#666">/</span>1000<span style="color:#666">.</span><span style="color:#4070a0">0</span><span style="color:#666">));</span>
</span></span><span style="display:flex;"><span>        startTime <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#4070a0">currentTimeMillis</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span>startTime<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        executor1 <span style="color:#666">=</span> Executors<span style="color:#666">.</span><span style="color:#4070a0">newFixedThreadPool</span><span style="color:#666">(</span>2<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        executor1<span style="color:#666">.</span><span style="color:#4070a0">execute</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> Computation<span style="color:#666">());</span>
</span></span><span style="display:flex;"><span>        executor1<span style="color:#666">.</span><span style="color:#4070a0">execute</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> Computation<span style="color:#666">());</span>
</span></span><span style="display:flex;"><span>        executor1<span style="color:#666">.</span><span style="color:#4070a0">shutdown</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>        executor1<span style="color:#666">.</span><span style="color:#4070a0">awaitTermination</span><span style="color:#666">(</span>60<span style="color:#666">,</span> TimeUnit<span style="color:#666">.</span><span style="color:#4070a0">SECONDS</span><span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        delay <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#4070a0">currentTimeMillis</span><span style="color:#666">()</span> <span style="color:#666">-</span> startTime<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;finished 2 threads in &#34;</span><span style="color:#666">+(</span>delay<span style="color:#666">/</span>1000<span style="color:#666">.</span><span style="color:#4070a0">0</span><span style="color:#666">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Computation</span> <span style="color:#007020;font-weight:bold">implements</span> Runnable <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">volatile</span> <span style="color:#902000">int</span> count <span style="color:#666">=</span> 0<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#007020;font-weight:bold">private</span> <span style="color:#902000">double</span> <span style="color:#06287e">computePi</span><span style="color:#666">()</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#902000">double</span> pi <span style="color:#666">=</span> 0<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#902000">double</span> x<span style="color:#666">,</span>y<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#902000">int</span> n <span style="color:#666">=</span> 10000000<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">for</span> <span style="color:#666">(</span><span style="color:#902000">int</span> i<span style="color:#666">=</span>0<span style="color:#666">;</span>i<span style="color:#666">&lt;</span>n<span style="color:#666">;</span>i<span style="color:#666">++)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                x <span style="color:#666">=</span> Math<span style="color:#666">.</span><span style="color:#4070a0">random</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>                x <span style="color:#666">*=</span> x<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>                y <span style="color:#666">=</span> Math<span style="color:#666">.</span><span style="color:#4070a0">random</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>                y <span style="color:#666">*=</span> y<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>x<span style="color:#666">+</span>y <span style="color:#666">&lt;</span> 1<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                    pi <span style="color:#666">+=</span>1<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>            pi <span style="color:#666">=</span> 4<span style="color:#666">*</span>pi<span style="color:#666">/</span>n<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">return</span> pi<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">run</span><span style="color:#666">()</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#902000">double</span> pi <span style="color:#666">=</span> computePi<span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#902000">long</span> time <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#4070a0">currentTimeMillis</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span>time<span style="color:#666">+</span><span style="color:#4070a0">&#34; thread &#34;</span><span style="color:#666">+</span>Thread<span style="color:#666">.</span><span style="color:#4070a0">currentThread</span><span style="color:#666">().</span><span style="color:#4070a0">getId</span><span style="color:#666">()+</span><span style="color:#4070a0">&#34; pi=&#34;</span><span style="color:#666">+</span>pi<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>            count<span style="color:#666">++;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>        
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">main</span><span style="color:#666">(</span>String<span style="color:#666">[]</span> args<span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">throws</span> Exception <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        startExecutors<span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span><span style="color:#666">}</span> </span></span></code></pre></div>
<p>Did you figure out why?</p>
<p>It took me less time with this simple code than with the original ring test to find out why. It is simply because of the Math.random call. Math.random only creates one random number generator, and it will be shared among threads. So every thread will wait at the other one at this point. Creating one random generator per thread showed 2 threads were much faster than 1, finally.</p>
<p>Back to the original ring test. Adding the correct way to compute Pi by Monte Carlo, I now had decent test results as long as the number of iterations is not too small. 10 iterations is enough to show a real difference between N threads and 1. Adding a small computation helps figuring out what happens behind the scene. You can also verify D Andreou claim, using only 1 start message the single threaded version is faster. If computation is too weak (for example number of Monte Carlo iteration of 0,  one only measures method calls between threads (context switching), which is obviously optimal for 1 thread. Measuring Actor libraries on it is dangerous: if I write a single threaded Actor library, it will be the fastest of this test, but it certainly is not what you want to use as Actor library.</p>
<p>Let&rsquo;s see now how Scala fares compared to the Plain Java solution, using computation:</p>
<p> 
<TABLE WIDTH=681 BORDER=1 BORDERCOLOR="#000000" CELLPADDING=4 CELLSPACING=0 RULES=NONE>  <COL WIDTH=79>  <COL WIDTH=173>  <COL WIDTH=145>  <COL WIDTH=250>  <TR VALIGN=BOTTOM>   <TD WIDTH=79 HEIGHT=10>    <P ALIGN=LEFT>Machine</P>   </TD>   <TD WIDTH=173>    <P ALIGN=LEFT>Algorithm</P>   </TD>   <TD WIDTH=145>    <P ALIGN=LEFT>Time for 100000 ring count, 10 mc, 4 messages</P>   </TD>   <TD WIDTH=250>    <P ALIGN=LEFT>Time for 10000 ring count, 100 mc, 4 messages</P>   </TD>  </TR>  <TR VALIGN=BOTTOM>   <TD WIDTH=79 HEIGHT=11>    <P ALIGN=LEFT>Core2Duo</P>   </TD>   <TD WIDTH=173>    <P ALIGN=LEFT>OptimizedRing 2 Threads</P>   </TD>   <TD WIDTH=145>    <P ALIGN=LEFT><SPAN STYLE="background: #ffff00">57s</SPAN></P>   </TD>   <TD WIDTH=250>    <P ALIGN=LEFT>37s</P>   </TD>  </TR>  <TR VALIGN=BOTTOM>   <TD WIDTH=79 HEIGHT=11>    <P ALIGN=LEFT>Core2Duo</P>   </TD>   <TD WIDTH=173>    <P ALIGN=LEFT>OptimizedRing 4 Threads</P>   </TD>   <TD WIDTH=145>    <P ALIGN=LEFT>78s</P>   </TD>   <TD WIDTH=250>    <P ALIGN=LEFT>39s</P>   </TD>  </TR>  <TR VALIGN=BOTTOM>   <TD WIDTH=79 HEIGHT=11>    <P ALIGN=LEFT>Core2Duo</P>   </TD>   <TD WIDTH=173>    <P ALIGN=LEFT>Scala Actors</P>   </TD>   <TD WIDTH=145>    <P ALIGN=LEFT><SPAN STYLE="background: #00ff00">82s</SPAN></P>   </TD>   <TD WIDTH=250>    <P ALIGN=LEFT>47s</P>   </TD>  </TR>  <TR VALIGN=BOTTOM>   <TD WIDTH=79 HEIGHT=11>    <P ALIGN=LEFT>Core2Duo</P>   </TD>   <TD WIDTH=173>    <P ALIGN=LEFT>SimpleRing (100 Threads)</P>   </TD>   <TD WIDTH=145>    <P ALIGN=LEFT><SPAN STYLE="background: #ff0000">137s</SPAN></P>   </TD>   <TD WIDTH=250>    <P ALIGN=LEFT><SPAN STYLE="background: #ff0000">58s</SPAN></P>   </TD>  </TR>  <TR VALIGN=BOTTOM>   <TD WIDTH=79 HEIGHT=11>    <P ALIGN=LEFT>Core2Duo</P>   </TD>   <TD WIDTH=173>    <P ALIGN=LEFT>OptimizedRing 1 Thread</P>   </TD>   <TD WIDTH=145>    <P ALIGN=LEFT>89s</P>   </TD>   <TD WIDTH=250>    <P ALIGN=LEFT>71s</P>   </TD>  </TR>  <TR VALIGN=BOTTOM>   <TD WIDTH=79 HEIGHT=11>    <P ALIGN=LEFT>Core2Quad</P>   </TD>   <TD WIDTH=173>    <P ALIGN=LEFT>OptimizedRing 4 Threads</P>   </TD>   <TD WIDTH=145>    <P ALIGN=LEFT>81s</P>   </TD>   <TD WIDTH=250>    <P ALIGN=LEFT><SPAN STYLE="background: #ffff00">25s</SPAN></P>   </TD>  </TR>  <TR VALIGN=BOTTOM>   <TD WIDTH=79 HEIGHT=11>    <P ALIGN=LEFT>Core2Quad</P>   </TD>   <TD WIDTH=173>    <P ALIGN=LEFT>Scala Actors</P>   </TD>   <TD WIDTH=145>    <P ALIGN=LEFT>71s</P>   </TD>   <TD WIDTH=250>    <P ALIGN=LEFT><SPAN STYLE="background: #00ff00">30s</SPAN></P>   </TD>  </TR>  <TR VALIGN=BOTTOM>   <TD WIDTH=79 HEIGHT=11>    <P ALIGN=LEFT>Core2Quad</P>   </TD>   <TD WIDTH=173>    <P ALIGN=LEFT>OptimizedRing 2 Threads</P>   </TD>   <TD WIDTH=145>    <P ALIGN=LEFT>61s</P>   </TD>   <TD WIDTH=250>    <P ALIGN=LEFT>43s</P>   </TD>  </TR>  <TR VALIGN=BOTTOM>   <TD WIDTH=79 HEIGHT=10>    <P ALIGN=LEFT>Core2Quad</P>   </TD>   <TD WIDTH=173>    <P ALIGN=LEFT>OptimizedRing 1 Threads</P>   </TD>   <TD WIDTH=145>    <P ALIGN=LEFT>100s</P>   </TD>   <TD WIDTH=250>    <P ALIGN=LEFT>80s</P>   </TD>  </TR> </TABLE>


The Core2Duo is Intel(R) Core(TM)2 Duo CPU     T7250  @ 2.00GHz
The Core2Quad is Intel(R) Core(TM)2 Quad CPU    Q6600  @ 2.40GHz</p>
<p>It is interesting to compare results of 4 threads on a biprocessor with monte carlo count of 10 and 100. We see a much higher thread overhead with fewer computation. With too few computation in monte carlo, the overhead of threads is too high over 2 concurrent threads. This explains why the very simple threading architecture fares much better in the last column compared to the previous one.</p>
<p>Scala Actors fares much better when it is not hindered in the creation of too many threads. It seem actually very good at abstracting multithreading intricacies, while still providing near Java performance in the real world where each actor does enough computation and multithreading is important.</p>

  
</article><article class="post">
  <h1 class="post-title">
    <a href="https://chasethedevil.github.io/post/object-oriented-analysis-and-design-with-applications-book-review/">Object Oriented Analysis And Design with Applications Book Review</a>
  </h1>
  <time datetime="2009-01-08T17:24:00Z" class="post-date">Thu, Jan 8, 2009</time>
  <p>A while ago, I had a comment from someone implying I knew nothing about OO programming because I had not mentioned (and therefore read) <em>Object Oriented Analysis And Design with Applications</em> from G. Booch. I was intrigued by such a silly comment and decided to look at this book that was considered as the bible of OOP.</p>
<p>Well, I don&rsquo;t find it that good! But I don&rsquo;t find the bible particularly good either. I like <a href="http://archive.eiffel.com/doc/oosc/">B. Meyer Object Oriented Software Construction</a> book much more, because it is more practical, more in touch with realities while pointing at the real important problems like:</p>
<blockquote>
<p>Real systems have no top</p>
</blockquote>
<p>In contrast G Booch book has too much evident concepts that don&rsquo;t really make you learn anything or think things a different way. It is a good book for someone who is learning OO for the first time. It covers the subject in details, but I did not find anything in it that made me say</p>
<blockquote>
<p>wow!</p>
</blockquote>
<p>It is like most other book you can find on OO. Furthermore only the first parts are on OO, the rest is more a UML tutorial.</p>

  
</article><article class="post">
  <h1 class="post-title">
    <a href="https://chasethedevil.github.io/post/running-rings-around-plain-java---the-killer-code/">Running Rings Around Plain Java - The Killer Code</a>
  </h1>
  <time datetime="2009-01-08T13:21:00Z" class="post-date">Thu, Jan 8, 2009</time>
  <p>I wrote my <a href="/post/running-rings-around-plain-java">previous</a> post too fast. I found a very simple change that increases the speed x6!</p>
<p>The idea is too process messages in a ThreadPoolExecutor. As my Nodes are Runnable, I just needed to initialize a common ThreadPoolExecutor, and in a sendMessage, execute the runnable each time.</p>
<p>Here is the full code:
 

<font face="monospace"><font color="#2e8b57"><b>public</b></font>&nbsp;<font color="#2e8b57"><b>class</b></font>&nbsp;OptimizedRing {<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;ExecutorService executor;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;<font color="#2e8b57"><b>static</b></font>&nbsp;<font color="#2e8b57"><b>void</b></font>&nbsp;main(String[]&nbsp;args)&nbsp;<font color="#2e8b57"><b>throws</b></font>&nbsp;Exception {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OptimizedRing ring = <font color="#a52a2a"><b>new</b></font>&nbsp;OptimizedRing();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RingNode node = ring.startRing(Integer.parseInt(args[<span style="background-color: #f2f2f2"><font color="#ff00ff">0</font></span>]));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.sendMessage(<font color="#a52a2a"><b>new</b></font>&nbsp;StartMessage());<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;RingNode startRing(<font color="#2e8b57"><b>int</b></font>&nbsp;n)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RingNode[]&nbsp;nodes = spawnNodes(n, startTimer());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connectNodes(n, nodes);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>return</b></font>&nbsp;nodes[<span style="background-color: #f2f2f2"><font color="#ff00ff">0</font></span>];<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;Timer startTimer()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Timer timer = <font color="#a52a2a"><b>new</b></font>&nbsp;Timer();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>new</b></font>&nbsp;Thread(timer).start();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>return</b></font>&nbsp;timer;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;RingNode[]&nbsp;spawnNodes(<font color="#2e8b57"><b>int</b></font>&nbsp;n, <font color="#2e8b57"><b>final</b></font>&nbsp;Timer timer)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;constructing nodes&quot;</font></span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>long</b></font>&nbsp;start = System.currentTimeMillis();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;executor = Executors.newFixedThreadPool(<span style="background-color: #f2f2f2"><font color="#ff00ff">4</font></span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RingNode[]&nbsp;nodes = <font color="#a52a2a"><b>new</b></font>&nbsp;RingNode[n+<span style="background-color: #f2f2f2"><font color="#ff00ff">1</font></span>];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>for</b></font>&nbsp;(<font color="#2e8b57"><b>int</b></font>&nbsp;i = <span style="background-color: #f2f2f2"><font color="#ff00ff">0</font></span>; i &lt; n ; i++)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodes[i]&nbsp;= <font color="#a52a2a"><b>new</b></font>&nbsp;RingNode(i, timer, <span style="background-color: #f2f2f2"><font color="#ff00ff">null</font></span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>long</b></font>&nbsp;end = System.currentTimeMillis();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;Took &quot;</font></span>+(end-start)+<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;ms to construct &quot;</font></span>+n+<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot; nodes&quot;</font></span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>return</b></font>&nbsp;nodes;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>void</b></font>&nbsp;connectNodes(<font color="#2e8b57"><b>int</b></font>&nbsp;n, RingNode[]&nbsp;nodes)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;connecting nodes&quot;</font></span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodes[n]&nbsp;= nodes[<span style="background-color: #f2f2f2"><font color="#ff00ff">0</font></span>];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>for</b></font>&nbsp;(<font color="#2e8b57"><b>int</b></font>&nbsp;i=<span style="background-color: #f2f2f2"><font color="#ff00ff">0</font></span>; i&lt;n; i++)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodes[i].connect(nodes[i+<span style="background-color: #f2f2f2"><font color="#ff00ff">1</font></span>]);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>interface</b></font>&nbsp;Message {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String getType();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>static</b></font>&nbsp;<font color="#2e8b57"><b>class</b></font>&nbsp;StartMessage <font color="#2e8b57"><b>implements</b></font>&nbsp;Message {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;String getType()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>return</b></font>&nbsp;<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;START&quot;</font></span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>static</b></font>&nbsp;<font color="#2e8b57"><b>class</b></font>&nbsp;StopMessage <font color="#2e8b57"><b>implements</b></font>&nbsp;Message {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;String getType()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>return</b></font>&nbsp;<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;STOP&quot;</font></span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>static</b></font>&nbsp;<font color="#2e8b57"><b>class</b></font>&nbsp;CancelMessage <font color="#2e8b57"><b>implements</b></font>&nbsp;Message {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;String getType()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>return</b></font>&nbsp;<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;CANCEL&quot;</font></span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>static</b></font>&nbsp;<font color="#2e8b57"><b>class</b></font>&nbsp;TokenMessage <font color="#2e8b57"><b>implements</b></font>&nbsp;Message {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>int</b></font>&nbsp;nodeId;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>int</b></font>&nbsp;value;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;TokenMessage(<font color="#2e8b57"><b>int</b></font>&nbsp;nodeId, <font color="#2e8b57"><b>int</b></font>&nbsp;value)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>this</b></font>.nodeId = nodeId;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>this</b></font>.value = value;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;String getType()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>return</b></font>&nbsp;<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;TOKEN&quot;</font></span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>class</b></font>&nbsp;RingNode <font color="#2e8b57"><b>implements</b></font>&nbsp;Runnable {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>int</b></font>&nbsp;nodeId;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;Timer timer;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;RingNode nextNode;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;BlockingQueue&lt;Message&gt; queue = <font color="#a52a2a"><b>new</b></font>&nbsp;LinkedBlockingQueue&lt;Message&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>boolean</b></font>&nbsp;isActive = <span style="background-color: #f2f2f2"><font color="#ff00ff">false</font></span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;RingNode(<font color="#2e8b57"><b>int</b></font>&nbsp;id, Timer timer, RingNode nextNode)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodeId = id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>this</b></font>.timer = timer;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>this</b></font>.nextNode = nextNode;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;<font color="#2e8b57"><b>void</b></font>&nbsp;connect(RingNode node)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextNode = node;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isActive = <span style="background-color: #f2f2f2"><font color="#ff00ff">true</font></span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;<font color="#2e8b57"><b>void</b></font>&nbsp;sendMessage(Message m)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;queue.add(m);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;executor.execute(<font color="#2e8b57"><b>this</b></font>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;<font color="#2e8b57"><b>void</b></font>&nbsp;run()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(isActive)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>try</b></font>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Message m = queue.take();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(m <font color="#a52a2a"><b>instanceof</b></font>&nbsp;StartMessage)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log(<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;Starting messages&quot;</font></span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timer.sendMessage(m);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextNode.sendMessage(<font color="#a52a2a"><b>new</b></font>&nbsp;TokenMessage(nodeId, <span style="background-color: #f2f2f2"><font color="#ff00ff">0</font></span>));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <font color="#a52a2a"><b>else</b></font>&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(m <font color="#a52a2a"><b>instanceof</b></font>&nbsp;StopMessage)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log(<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;Stopping&quot;</font></span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextNode.sendMessage(m);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isActive = <span style="background-color: #f2f2f2"><font color="#ff00ff">false</font></span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">//</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <font color="#a52a2a"><b>else</b></font>&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(m <font color="#a52a2a"><b>instanceof</b></font>&nbsp;TokenMessage)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(((TokenMessage)m).nodeId == nodeId)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>int</b></font>&nbsp;nextValue = ((TokenMessage)m).value + <span style="background-color: #f2f2f2"><font color="#ff00ff">1</font></span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(nextValue % <span style="background-color: #f2f2f2"><font color="#ff00ff">10000</font></span>&nbsp;== <span style="background-color: #f2f2f2"><font color="#ff00ff">0</font></span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log(<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;Around ring &quot;</font></span>+nextValue+<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot; times&quot;</font></span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(nextValue == <span style="background-color: #f2f2f2"><font color="#ff00ff">1000000</font></span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timer.sendMessage(<font color="#a52a2a"><b>new</b></font>&nbsp;StopMessage());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timer.sendMessage(<font color="#a52a2a"><b>new</b></font>&nbsp;CancelMessage());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextNode.sendMessage(<font color="#a52a2a"><b>new</b></font>&nbsp;StopMessage());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isActive = <span style="background-color: #f2f2f2"><font color="#ff00ff">false</font></span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <font color="#a52a2a"><b>else</b></font>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextNode.sendMessage(<font color="#a52a2a"><b>new</b></font>&nbsp;TokenMessage(nodeId, nextValue));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <font color="#a52a2a"><b>else</b></font>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextNode.sendMessage(m);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <font color="#a52a2a"><b>catch</b></font>&nbsp;(InterruptedException ie)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ie.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;<font color="#2e8b57"><b>void</b></font>&nbsp;log(String s)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(System.currentTimeMillis()+<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot; &quot;</font></span>+nodeId+<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;: &quot;</font></span>+s);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>static</b></font>&nbsp;<font color="#2e8b57"><b>class</b></font>&nbsp;Timer <font color="#2e8b57"><b>implements</b></font>&nbsp;Runnable {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;BlockingQueue&lt;Message&gt; queue = <font color="#a52a2a"><b>new</b></font>&nbsp;LinkedBlockingQueue&lt;Message&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>boolean</b></font>&nbsp;timing = <span style="background-color: #f2f2f2"><font color="#ff00ff">false</font></span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>private</b></font>&nbsp;<font color="#2e8b57"><b>long</b></font>&nbsp;startTime;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;<font color="#2e8b57"><b>void</b></font>&nbsp;sendMessage(Message m)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">//we don't need to change this implementation as timer is rarely called</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;queue.add(m);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>public</b></font>&nbsp;<font color="#2e8b57"><b>void</b></font>&nbsp;run()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>while</b></font>&nbsp;(<span style="background-color: #f2f2f2"><font color="#ff00ff">true</font></span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Message m;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>try</b></font>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m = queue.take();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(m <font color="#a52a2a"><b>instanceof</b></font>&nbsp;StartMessage)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;startTime = System.currentTimeMillis();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timing = <span style="background-color: #f2f2f2"><font color="#ff00ff">true</font></span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <font color="#a52a2a"><b>else</b></font>&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(m <font color="#a52a2a"><b>instanceof</b></font>&nbsp;StopMessage)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#2e8b57"><b>long</b></font>&nbsp;end = System.currentTimeMillis();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot;Start=&quot;</font></span>+startTime+<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot; Stop=&quot;</font></span>+end+<span style="background-color: #f2f2f2"><font color="#ff00ff">&quot; Elapsed=&quot;</font></span>+(end-startTime));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timing = <span style="background-color: #f2f2f2"><font color="#ff00ff">false</font></span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <font color="#a52a2a"><b>else</b></font>&nbsp;<font color="#a52a2a"><b>if</b></font>&nbsp;(m <font color="#a52a2a"><b>instanceof</b></font>&nbsp;CancelMessage)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#a52a2a"><b>break</b></font>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <font color="#a52a2a"><b>catch</b></font>&nbsp;(InterruptedException e)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></font><br /><br /><table class="" id="swje" bgcolor="#eeeeee" border="2" bordercolor="#ffffff" cellpadding="3" cellspacing="2" width="100%"><tbody><tr><td style="text-align: center;" width="33%">Code<br></td><br /><td style="text-align: center;" width="33%">Spawn<br></td><td style="text-align: center;" width="33%">Send 100M messages<br></td></tr><tr><td width="33%">Scala Actors<br></td><td style="text-align: right;" width="33%">15ms<br></td><td style="text-align: right;" width="33%">270104ms<br></td></tr><tr><td width="33%">SimpleRing<br></td><td style="text-align: right;" width="33%">11ms<br></td><td style="text-align: right;" width="33%">493073ms<br></td><br /></tr><tr><td width="33%">OptimizedRing (4 threads)<br></td><td style="text-align: right;" width="33%">6ms<br><br /></td><td style="text-align: right;" width="33%"><span>84727ms</span></td></tr><tr><td width="33%">OptimizedRing (5+ threads)<br></td><td style="text-align: right;" width="33%">5ms<br><br /></td><td style="text-align: right;" width="33%"><span>62593ms</span></td></tr><tr><td width="33%">OptimizedRing (1 thread)<br></td><td style="text-align: right;" width="33%">5ms<br><br /></td><td style="text-align: right;" width="33%"><span>60660ms</span></td></tr></tbody></table><br /><br />I finally saw my 4 cores used! Max multithreaded throughput is achieved at 5 threads. However 1 thread is faster. Is this related to memory bandwith limit?<br /><br />Now I am left wondering if actors are really that important if one can achieve much higher throughput using plain Java and very simple concepts (BlockingQueue, ThreadPoolExecutor). Worse, this test is actually faster with only 1 thread...

</p>

  
</article><article class="post">
  <h1 class="post-title">
    <a href="https://chasethedevil.github.io/post/running-rings-around-plain-java/">Running rings around plain Java</a>
  </h1>
  <time datetime="2009-01-08T12:26:00Z" class="post-date">Thu, Jan 8, 2009</time>
  <p>Alex Miller has a very <a href="http://tech.puredanger.com/2009/01/05/scala-ring/">interesting test of Actors</a>. He finds out Scala performance is relatively low compared to Erlang, and Kilim is very near Erlang. But Kilim code is the most difficult to read in the lot.</p>
<p>I thought it would be simple to just do the same test in plain Java. I wrote the code for it duplicating the scala logic using Threads instead of Actors.</p>
<p><div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SimpleRing</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">public</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#902000">void</span> <span style="color:#06287e">main</span><span style="color:#666">(</span>String<span style="color:#666">[]</span> args<span style="color:#666">)</span> <span style="color:#007020;font-weight:bold">throws</span> Exception <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        SimpleRing ring <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> SimpleRing<span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>        RingNode node <span style="color:#666">=</span> ring<span style="color:#666">.</span><span style="color:#4070a0">startRing</span><span style="color:#666">(</span>Integer<span style="color:#666">.</span><span style="color:#4070a0">parseInt</span><span style="color:#666">(</span>args<span style="color:#666">[</span>0<span style="color:#666">]));</span>
</span></span><span style="display:flex;"><span>        node<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> StartMessage<span style="color:#666">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">public</span> RingNode <span style="color:#06287e">startRing</span><span style="color:#666">(</span><span style="color:#902000">int</span> n<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        RingNode<span style="color:#666">[]</span> nodes <span style="color:#666">=</span> spawnNodes<span style="color:#666">(</span>n<span style="color:#666">,</span> startTimer<span style="color:#666">());</span>
</span></span><span style="display:flex;"><span>        connectNodes<span style="color:#666">(</span>n<span style="color:#666">,</span> nodes<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">return</span> nodes<span style="color:#666">[</span>0<span style="color:#666">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">private</span> Timer <span style="color:#06287e">startTimer</span><span style="color:#666">()</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        Timer timer <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> Timer<span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">new</span> Thread<span style="color:#666">(</span>timer<span style="color:#666">).</span><span style="color:#4070a0">start</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">return</span> timer<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">private</span> RingNode<span style="color:#666">[]</span> <span style="color:#06287e">spawnNodes</span><span style="color:#666">(</span><span style="color:#902000">int</span> n<span style="color:#666">,</span> <span style="color:#007020;font-weight:bold">final</span> Timer timer<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;constructing nodes&#34;</span><span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#902000">long</span> start <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#4070a0">currentTimeMillis</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>        RingNode<span style="color:#666">[]</span> nodes <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> RingNode<span style="color:#666">[</span>n<span style="color:#666">+</span>1<span style="color:#666">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">for</span> <span style="color:#666">(</span><span style="color:#902000">int</span> i <span style="color:#666">=</span> 0<span style="color:#666">;</span> i <span style="color:#666">&lt;</span> n <span style="color:#666">;</span> i<span style="color:#666">++)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            nodes<span style="color:#666">[</span>i<span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> RingNode<span style="color:#666">(</span>i<span style="color:#666">,</span> timer<span style="color:#666">,</span> <span style="color:#007020;font-weight:bold">null</span><span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">new</span> Thread<span style="color:#666">(</span>nodes<span style="color:#666">[</span>i<span style="color:#666">]).</span><span style="color:#4070a0">start</span><span style="color:#666">();</span> <span style="color:#60a0b0;font-style:italic">//later use pool
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"></span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#902000">long</span> end <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#4070a0">currentTimeMillis</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;Took &#34;</span><span style="color:#666">+(</span>end<span style="color:#666">-</span>start<span style="color:#666">)+</span><span style="color:#4070a0">&#34;ms to construct &#34;</span><span style="color:#666">+</span>n<span style="color:#666">+</span><span style="color:#4070a0">&#34; nodes&#34;</span><span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">return</span> nodes<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#902000">void</span> <span style="color:#06287e">connectNodes</span><span style="color:#666">(</span><span style="color:#902000">int</span> n<span style="color:#666">,</span> RingNode<span style="color:#666">[]</span> nodes<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;connecting nodes&#34;</span><span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        nodes<span style="color:#666">[</span>n<span style="color:#666">]</span> <span style="color:#666">=</span> nodes<span style="color:#666">[</span>0<span style="color:#666">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">for</span> <span style="color:#666">(</span><span style="color:#902000">int</span> i<span style="color:#666">=</span>0<span style="color:#666">;</span> i<span style="color:#666">&lt;</span>n<span style="color:#666">;</span> i<span style="color:#666">++)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            nodes<span style="color:#666">[</span>i<span style="color:#666">].</span><span style="color:#4070a0">connect</span><span style="color:#666">(</span>nodes<span style="color:#666">[</span>i<span style="color:#666">+</span>1<span style="color:#666">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Message</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        String <span style="color:#06287e">getType</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">StartMessage</span> <span style="color:#007020;font-weight:bold">implements</span> Message <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> String <span style="color:#06287e">getType</span><span style="color:#666">()</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">return</span> <span style="color:#4070a0">&#34;START&#34;</span><span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">StopMessage</span> <span style="color:#007020;font-weight:bold">implements</span> Message <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> String <span style="color:#06287e">getType</span><span style="color:#666">()</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">return</span> <span style="color:#4070a0">&#34;STOP&#34;</span><span style="color:#666">;</span>            
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">CancelMessage</span> <span style="color:#007020;font-weight:bold">implements</span> Message <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> String <span style="color:#06287e">getType</span><span style="color:#666">()</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">return</span> <span style="color:#4070a0">&#34;CANCEL&#34;</span><span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">TokenMessage</span> <span style="color:#007020;font-weight:bold">implements</span> Message <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">private</span> <span style="color:#902000">int</span> nodeId<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">private</span> <span style="color:#902000">int</span> value<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> <span style="color:#06287e">TokenMessage</span><span style="color:#666">(</span><span style="color:#902000">int</span> nodeId<span style="color:#666">,</span> <span style="color:#902000">int</span> value<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">nodeId</span> <span style="color:#666">=</span> nodeId<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">value</span> <span style="color:#666">=</span> value<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> String <span style="color:#06287e">getType</span><span style="color:#666">()</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">return</span> <span style="color:#4070a0">&#34;TOKEN&#34;</span><span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">RingNode</span> <span style="color:#007020;font-weight:bold">implements</span> Runnable <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">private</span> <span style="color:#902000">int</span> nodeId<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">private</span> Timer timer<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">private</span> RingNode nextNode<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">private</span> BlockingQueue<span style="color:#666">&lt;</span>Message<span style="color:#666">&gt;</span> queue <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> LinkedBlockingQueue<span style="color:#666">&lt;</span>Message<span style="color:#666">&gt;();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> <span style="color:#06287e">RingNode</span><span style="color:#666">(</span><span style="color:#902000">int</span> id<span style="color:#666">,</span> Timer timer<span style="color:#666">,</span> RingNode nextNode<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            nodeId <span style="color:#666">=</span> id<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">timer</span> <span style="color:#666">=</span> timer<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#4070a0">nextNode</span> <span style="color:#666">=</span> nextNode<span style="color:#666">;</span>                        
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">connect</span><span style="color:#666">(</span>RingNode node<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            nextNode <span style="color:#666">=</span> node<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">sendMessage</span><span style="color:#666">(</span>Message m<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            queue<span style="color:#666">.</span><span style="color:#4070a0">add</span><span style="color:#666">(</span>m<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">run</span><span style="color:#666">()</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">while</span> <span style="color:#666">(</span><span style="color:#007020;font-weight:bold">true</span><span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007020;font-weight:bold">try</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                    Message m <span style="color:#666">=</span> queue<span style="color:#666">.</span><span style="color:#4070a0">take</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>m <span style="color:#007020;font-weight:bold">instanceof</span> StartMessage<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                        log<span style="color:#666">(</span><span style="color:#4070a0">&#34;Starting messages&#34;</span><span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>                        timer<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span>m<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>                        nextNode<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> TokenMessage<span style="color:#666">(</span>nodeId<span style="color:#666">,</span> 0<span style="color:#666">));</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">else</span> <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>m <span style="color:#007020;font-weight:bold">instanceof</span> StopMessage<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                        log<span style="color:#666">(</span><span style="color:#4070a0">&#34;Stopping&#34;</span><span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>                        nextNode<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span>m<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#007020;font-weight:bold">break</span><span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">else</span> <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>m <span style="color:#007020;font-weight:bold">instanceof</span> TokenMessage<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(((</span>TokenMessage<span style="color:#666">)</span>m<span style="color:#666">).</span><span style="color:#4070a0">nodeId</span> <span style="color:#666">==</span> nodeId<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#902000">int</span> nextValue <span style="color:#666">=</span> <span style="color:#666">((</span>TokenMessage<span style="color:#666">)</span>m<span style="color:#666">).</span><span style="color:#4070a0">value</span> <span style="color:#666">+</span> 1<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>nextValue <span style="color:#666">%</span> 10000 <span style="color:#666">==</span> 0<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                                log<span style="color:#666">(</span><span style="color:#4070a0">&#34;Around ring &#34;</span><span style="color:#666">+</span>nextValue<span style="color:#666">+</span><span style="color:#4070a0">&#34; times&#34;</span><span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>nextValue <span style="color:#666">==</span> 1000000<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                                timer<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> StopMessage<span style="color:#666">());</span>
</span></span><span style="display:flex;"><span>                                timer<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> CancelMessage<span style="color:#666">());</span>
</span></span><span style="display:flex;"><span>                                nextNode<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> StopMessage<span style="color:#666">());</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#007020;font-weight:bold">break</span><span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">else</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                                nextNode<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span><span style="color:#007020;font-weight:bold">new</span> TokenMessage<span style="color:#666">(</span>nodeId<span style="color:#666">,</span> nextValue<span style="color:#666">));</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">else</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                            nextNode<span style="color:#666">.</span><span style="color:#4070a0">sendMessage</span><span style="color:#666">(</span>m<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">catch</span> <span style="color:#666">(</span>InterruptedException ie<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                    ie<span style="color:#666">.</span><span style="color:#4070a0">printStackTrace</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">log</span><span style="color:#666">(</span>String s<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span>System<span style="color:#666">.</span><span style="color:#4070a0">currentTimeMillis</span><span style="color:#666">()+</span><span style="color:#4070a0">&#34; &#34;</span><span style="color:#666">+</span>nodeId<span style="color:#666">+</span><span style="color:#4070a0">&#34;: &#34;</span><span style="color:#666">+</span>s<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">private</span> <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Timer</span> <span style="color:#007020;font-weight:bold">implements</span> Runnable <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">private</span> BlockingQueue<span style="color:#666">&lt;</span>Message<span style="color:#666">&gt;</span> queue <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">new</span> LinkedBlockingQueue<span style="color:#666">&lt;</span>Message<span style="color:#666">&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">private</span> <span style="color:#902000">boolean</span> timing <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">false</span><span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">private</span> <span style="color:#902000">long</span> startTime<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">sendMessage</span><span style="color:#666">(</span>Message m<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            queue<span style="color:#666">.</span><span style="color:#4070a0">add</span><span style="color:#666">(</span>m<span style="color:#666">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">public</span> <span style="color:#902000">void</span> <span style="color:#06287e">run</span><span style="color:#666">()</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">while</span> <span style="color:#666">(</span><span style="color:#007020;font-weight:bold">true</span><span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                Message m<span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007020;font-weight:bold">try</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                    m <span style="color:#666">=</span> queue<span style="color:#666">.</span><span style="color:#4070a0">take</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>m <span style="color:#007020;font-weight:bold">instanceof</span> StartMessage<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                        startTime <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#4070a0">currentTimeMillis</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>                        timing <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">true</span><span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">else</span> <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>m <span style="color:#007020;font-weight:bold">instanceof</span> StopMessage<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#902000">long</span> end <span style="color:#666">=</span> System<span style="color:#666">.</span><span style="color:#4070a0">currentTimeMillis</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>                        System<span style="color:#666">.</span><span style="color:#4070a0">out</span><span style="color:#666">.</span><span style="color:#4070a0">println</span><span style="color:#666">(</span><span style="color:#4070a0">&#34;Start=&#34;</span><span style="color:#666">+</span>startTime<span style="color:#666">+</span><span style="color:#4070a0">&#34; Stop=&#34;</span><span style="color:#666">+</span>end<span style="color:#666">+</span><span style="color:#4070a0">&#34; Elapsed=&#34;</span><span style="color:#666">+(</span>end<span style="color:#666">-</span>startTime<span style="color:#666">));</span>
</span></span><span style="display:flex;"><span>                        timing <span style="color:#666">=</span> <span style="color:#007020;font-weight:bold">false</span><span style="color:#666">;</span>                                        
</span></span><span style="display:flex;"><span>                    <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">else</span> <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">(</span>m <span style="color:#007020;font-weight:bold">instanceof</span> CancelMessage<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#007020;font-weight:bold">break</span><span style="color:#666">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#666">}</span> <span style="color:#007020;font-weight:bold">catch</span> <span style="color:#666">(</span>InterruptedException e<span style="color:#666">)</span> <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>                    e<span style="color:#666">.</span><span style="color:#4070a0">printStackTrace</span><span style="color:#666">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span><span style="color:#666">}</span></span></span></code></pre></div>
I was a bit surprised by the result. It was slow and only 1 thread was really active at one time. This is why the test is particularly good. It is not trivial to reproduce the functionality in plain Java in an effective manner. It really shows how the concept of Actors can be useful.</p>
<ul>
<li>
<p>SimpleRing</p>
<ul>
<li>spawn 100: 11ms</li>
<li>send 100M messages: 493073ms</li>
</ul>
</li>
<li>
<p>Scala Actors</p>
<ul>
<li>spawn 100: 15 ms</li>
<li>send 100M messages: 270104ms</li>
</ul>
</li>
</ul>
<p><strong>UPDATE</strong> with <a href="https://chasethedevil.github.io/post/running-rings-around-plain-java---the-killer-code/">slight changes</a> plain Java rocks!</p>

  
</article><article class="post">
  <h1 class="post-title">
    <a href="https://chasethedevil.github.io/post/more-double-troubles/">More Double Troubles</a>
  </h1>
  <time datetime="2009-01-06T12:12:00Z" class="post-date">Tue, Jan 6, 2009</time>
   

We saw in a previous entry how one has to be careful with <a href="http://chasethedevil.blogspot.com/2008/12/doublenan-is-evil.html">Double.NaN</a>. Today we will see how regular double can cause problems. By the way the NaN issue was not Java specific and this issue is also general in different programming languages.<br /><br />A coworker was shocked that in Java (I was a bit surprised he saw that only today, but it is true it can be surprising that such a simple thing does not work as expected):<br /><pre  wrap="" style="font-family:courier new;"><span style="font-size:85%;">408.16 - 40.82 = <span style="font-weight: bold;">367.34000000000003</span></span></pre>In C, this would lead to the same result. This is all due to the <a href="http://en.wikipedia.org/wiki/Double_precision">binary represention of double numbers</a>. Using the formula 2^(exponent)*1.mantissa where mantissa is on 52 bits, we have<br /><br />408.16 decomposition:<br /><ul><li>exponent = 256. Then 408.16/256 = 1.594375 = 1 + 0x9828F5C28F5C28F5C28F5C... * 2^-52<br /></li><li>We round to 52 bits, the mantissa is 0x9828F5C28F5C3 = 2676827028518339.</li><li>As a decimal, the internal value is (2676827028518339/2^52+1) * 256 = 408.1600000000000250111042987555265426635742</li></ul>40.82 decomposition:<br /><ul><li>exponent = 32. Then 40.82/32= 1.275625 = 1 + 0x468F5C28F5C28F5C...*2^-52</li><li>Rounded to 52 bits, the mantissa is 0x468F5C28F5C29 = 1241304647293993<br /></li><li>As a decimal, the internal value is (1241304647293993/2^52 + 1)*32 = 40.8200000000000002842170943040400743484497</li></ul>The difference in decimal becomes 367.34000000000002472... which becomes <span style="font-weight: bold;">367.34000000000003</span> when represented in binary (to convince yourself you can apply the same technique).<br /><br /><span style="font-weight: bold;font-family:arial;" >The Solution</span><br /><br />One solution to this problem is to use <a href="http://java.sun.com/j2se/1.5.0/docs/api/java/math/BigDecimal.html">java.math.BigDecimal</a> which stores a number as 2 integers, one for the digits, one for the exponent power of 10 (and not 2).<br />The correct code would become:<br /><span style=";font-family:courier new;font-size:85%;"  ><br />BigDecimal value = BigDecimal.valueOf(408.16).subtract(BigDecimal.valueOf(40.82));</span><br /><br />value would then be 367.34.<br /><br />But BigDecimal has also many potential for bugs. For example, you should <span style="font-weight: bold;">never use the constructor taking a double but always the one taking a String</span>.<br /><br /><span style="font-size:85%;"><span style="font-family:courier new;">new BigDecimal(408.16) = 408.16000000000002501110429875552654266357421875</span><br /></span><br />This is because of the binary representation of 408.16 as a double. 408.16 is only an approximation of 408.16!<br /><br />Another trick with BigDecimal is<span style="font-weight: bold;"> not to use equals(Object) but compareTo(Object)</span> because 408.160 is not equal to 408.16 using equals.<br /><br /><span style="font-weight: bold;font-family:arial;" >Why Could not They Make it Work With Double?</span><br /><br />If you were too lazy to follow the steps of the explanation. There is a simpler explanation. Imagine the representation of a number in base 3 with 2 "digits". Let's imagine 1/3 is represented as 0.1 (this is a very simple number representation) 1/3+1/3+1/3 becomes 0.1+0.1+0.1 = 1.0 (in base 3) = 1.0 if we convert to base 10. Now in base 10, 1/3 can only be represented as 0.3, so 1/3+1/3+1/3 = 0.3+0.3+0.3 = 0.9 <> 1.0.<br />So BigDecimal is only interesting to handle ... decimals! In the enterprise world, this should be most apps. It is a bit sad it appeared so late in the JDK. It should really be a primitive type.



  
</article><article class="post">
  <h1 class="post-title">
    <a href="https://chasethedevil.github.io/post/java-programmers-are-idiots/">Java Programmers Are Idiots?</a>
  </h1>
  <time datetime="2008-12-17T20:16:00Z" class="post-date">Wed, Dec 17, 2008</time>
  <p>My brother just sent me a funny quote. I don&rsquo;t know if it is true or not:</p>
<blockquote>
<p>entwickeln Sie lieber überzeugende Lösungen anstatt viele Stunden mit Coding zu verbringen? Ist Ihnen die Produktivität Ihres Teams wichtig?</p>
</blockquote>
<p>Mark Driver, <strong>VP Research von Gartner</strong>, kommentierte kürzlich</p>
<blockquote>
<p>&ldquo;Here’s a simple equation. In terms of mental fortitude&hellip;
1 Smalltalk developer = 2.5 C++ developers
1 C++ developer = 1.5 Java developers&rdquo;.</p>
</blockquote>
<p>You don&rsquo;t need german to understand. Of course it can not be true. How can anyone measure mental fortitude? And how does it related with productivity is another issue.</p>
<p>There is a famous email exchange from <a href="http://lwn.net/Articles/249460/">Linux Torvald claiming the advantages of C versus C++</a>, here is a quote:</p>
<blockquote>
<p>If you want a VCS that is written in C++, go play with Monotone. Really.They use a &ldquo;real database&rdquo;. They use &ldquo;nice object-oriented libraries&rdquo;. They use &ldquo;nice C++ abstractions&rdquo;. And quite frankly, as a result of all these design decisions that sound so appealing to some CS people, the end result is a horrible and unmaintainable mess.</p>
</blockquote>
<p>This however is quite interesting since I am probably not the only one to have seen the disastrous effects of too enthusiastic abstraction professionals in Java. This is why many Java projects are utter crap. But again, not everybody makes this mistake. Some people know how to build good things. As the result of Java being popular, we have many crap programmers with pseudo genius theories you don&rsquo;t find in C or Haskell.</p>
<p>On another subject, I seriously wonder why we don&rsquo;t have more distributed compilation in Java as in C/C++. I am tired of seing those core doing nothing while compiling.</p>

  
</article>
</div>
<p style="text-align:left; width:49%; display: inline-block;"><a href="/page/25/">Previous</a></p>
<p style="text-align:right; width:50%;  display: inline-block;"><a href="/page/27/">Next</a></p>
    </main>

    
      
    
  </body>
</html>
